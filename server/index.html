<!DOCTYPE html>
<html lang="en">
<head>

	<title>Socket Test</title>
	<meta charset="utf-8">

	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<meta name="title" content="neurron" />
	<meta name="description" content="Socket Test" />

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

</head>
<body>


	<canvas id="canvas" width="800" height="600"
			style="margin:0 auto; background:#000; display:block;"></canvas>



<!-- polyfill -->
<script>

	(function() {

		var lastTime = 0,
			vendors = ['ms', 'moz', 'webkit', 'o'],
			x;

		for ( x = 0; x < vendors.length && !window.requestAnimationFrame; ++x ) {

			window.requestAnimationFrame =	window[vendors[x]+'RequestAnimationFrame'];
			window.cancelAnimationFrame  =	window[vendors[x]+'CancelAnimationFrame'] ||
											window[vendors[x]+'CancelRequestAnimationFrame'];
		}

		if ( !window.requestAnimationFrame ) {

			window.requestAnimationFrame = function ( callback, element ) {

				var currTime = new Date().getTime(),
					timeToCall = Math.max(0, 16 - (currTime - lastTime)),
					id = window.setTimeout(function(){callback(currTime + timeToCall);}, timeToCall);

				lastTime = currTime + timeToCall;
				return id;
			};
		}

		if ( !window.cancelAnimationFrame ) {

			window.cancelAnimationFrame = function( id ) {

				clearTimeout(id);
			};
		}

	}());

</script>





	<script>

	// config

	var server = 'neurron.com',

		port = 2020,

		speed = 5;




	// connection
	var	socket = new WebSocket( 'ws://' + server + ':' + port );



	//
	var dir,

		time = (new Date()).getTime(), // http://de.wikipedia.org/wiki/Human_Response_Time || ~ 100ms

		id = 0,

		channel = null;


	socket.onopen = function () {

		console.log('[opened]');
	};


	socket.onclose = function ( msg ) {

		console.log('[closed]', msg);
	};

	socket.onmessage = function ( msg ) {

		console.log('[received]', msg);

		var data = msg.data;

		data = atob( data );


		if ( !channel ) {

			channel = data.charCodeAt(1);

			alert('ready  !');

		} else {


			var diff = (new Date()).getTime() - time;

			console.log(diff);

			id = data.charCodeAt(1);
			dir = data.charCodeAt(2);
		}
	};


	socket.onerror = function ( msg ) {

		console.log('[error]', msg);
	};


	function send( dir ){

		var req = new XMLHttpRequest(),

			url = 'http://' + server + ':' + 2020;

		time = (new Date()).getTime();

		req.open( 'POST', url, true );

		var data = btoa( String.fromCharCode(  channel, id, dir ) );

		req.setRequestHeader( 'Content-Type', 'text/plain; charset=UTF-8' );

		req.send( data );
	};



	// visual
	var cvs = document.getElementById('canvas'),
		ctx = cvs.getContext('2d'),

		width = cvs.width,
		height = cvs.height;

	ctx.fillStyle = 'red';

	var	size = 20,
		x = width/size,
		y = height/size;

	document.addEventListener('keydown', function( e ){

		// e.preventDefault();
		// e.stopPropagation();

		var key = e.which;

		if ( key === 37 ) send( '1' );//dir='x1';//x -= size;
		if ( key === 39 ) send( '2' );//dir='x2';//x += size;
		if ( key === 38 ) send( '3' );//dir='y1';//y -= size;
		if ( key === 40 ) send( '4' );//dir='y2';//y += size;
	});





	function move() {

		if ( dir === '1' ) x += speed;
		if ( dir === '2' ) x -= speed;
		if ( dir === '3' ) y -= speed;
		if ( dir === '4' ) y += speed;


		if ( x+size > width ) x = width-size;
		if ( x < 0 ) x = width-size;

		if ( y+size > height ) y = 0;
		if ( y < 0 ) y = height-size;


		ctx.fillRect( x, y, size, size );
	}


	(function loop(){

		requestAnimationFrame( loop );

		ctx.clearRect( 0,0, width, height )

		move();

	})();



	</script>


</body>
</html>
